---
# Initial config of a server to lock down ssh.
# LIMIT THE PLAY to the just the machine that you want set up.
# ansible-playbook site.yml --limit foobar --tags first

- name: first setup of new server
  hosts: all
  gather_facts: no
  remote_user: root
  port: 22
  vars:
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
    ansible_ssh_private_key_file: "{{ root_acct.sshkeypath }}"
  roles:
    - first
  tags: [ 'never', 'first' ]

# All tasks are run as the deploy user, which can sudo when needed.

# DNS needs to be up first so that certbot can find us to issue a
# cert.  This probably means a two phase thing - common firewall and
# dns, wait for propogation, and then the rest.   
- hosts: cloud
  remote_user: "{{ deploy_acct.name }}"
  become: True
  force_handlers: True      
  vars:
    ansible_ssh_common_args: '-o StrictHostKeyChecking=accept-new'
    ansible_ssh_private_key_file: "{{ deploy_acct.sshkeypath }}"
  roles:
    - { role: common, tags: common }
    - { role: apache, tags: apache }
    - { role: mail, tags: mail }
    - { role: bacula-client, tags: bacula-client }
 
- hosts: backup-server
  remote_user: "{{ deploy_acct.name }}"
  become: True
  force_handlers: True      
  vars:
    ansible_ssh_common_args: '-o StrictHostKeyChecking=accept-new'
    ansible_ssh_private_key_file: "{{ deploy_acct.sshkeypath }}"
    firewall_services: []
  roles:
    - { role: common, tags: common }
    - { role: bacula-director, tags: bacula-director }
    



    
    
