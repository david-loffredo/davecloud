<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Firewall</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
<div class=toc>
<UL>
<LI><A href=index.html>[home]</A>

<li><a href="#vars">Variables</a>
<li><a href="#why">Why These Packages?</a>
</UL>
</div>

<div class=main>
<H1>Firewall</H1>

<p><b>ROLE</b> common, firewall.yml

<p>We implement firewall rules directly using <code>iptables</code>,
with <code>iptables-persistent</code> to reload our configuration on
boot.  The playbook writes our IPv4 and IPv6 rules to
<code>/etc/iptables/testrules.v4</code> and <code>testrules.v6</code>,
and then runs <code>iptables-restore</code>
and <code>iptables-save</code> to round-trip them into
the <code>rules.v4</code> and <code>rules.v6</code> files that are
loaded at boot.</p>

<p>The rules drop all incoming connections unless explicitly enabled
by the variables described below.  It allows pings, but rate limits
them, and also drops unusually-formed packets.  We always open the ssh
port.</p>

<p>We run <code>fail2ban</code> to scan the logs for repeated
intrusion attempts and temporarily ban IPs.  We use a fairly
aggressive setting which may trip when trying to configure mail
clients.  You may want to use the <code>fail2ban-client</code> tool to
check the jails if you are having trouble connecting.</p>

<!-- ============================== -->
<H2 class=rule>
<A NAME=vars></A>Variables</H2>

<p>Open ports for new services by adding the symbolic name to
the <code>firewall_services</code> list.  It recongizes 'ssh', 'mail',
'web', 'dns', and 'bacula'.  You define your own names for services by
defining
<code>&lt;name&gt;_opentcp</code>
and/or <code>&lt;name&gt;_openudp</code> as a list of port numbers.
It doesn't matter if port numbers are repeated across services.  The
fail2ban setup also uses these names and sets up jails for sshd,
dovecot, postfix and a few others depending on what names are
present.</p>


<PRE class=code>
firewall_services: [ 'ssh' ]

# Define 'foobar' name for firewall services by defining:
#foobar_opentcp: [ 12345, 23456 ]
#foobar_openudp: [ 34567 ]
</PRE>

<p>The <code>firewall_opentcp</code> and <code>firewall_openudp</code>
variables are just lists of extra ports that will be opened.</p>

<PRE class=code>
# will append ports from the mnemonic list of services but can be
# initialized with extra ports.
firewall_opentcp: []
firewall_openudp: []
</PRE>

<p>If you want to drop all connections from certain IPs, add them to the
<code>firewall_blacklist_ips</code> list.</p>
  
<PRE class=code>
# blocked if defined
firewall_blacklist_ips: []
</PRE>



<!-- ============================== -->
<H2 class=rule>
<A NAME=why></A>Why These Packages?</H2>

<p>The <code>ufw</code> (universal firewall) package is a popular
choice for blocking everything except for a few ports, and it has a
convenient Ansible module.  It is very good for manually managing the
ports, but it is just a wrapper around <code>iptables</code>.</p>

<p>I decided to use <code>iptables</code> directly for two reasons.
First, it seemed that UFW took over everything, so it was not possible
to integrate with other tools like ipsets.  However, a closer read of
the docs shows that it just manages iptables-save files
in <code>/etc/ufw</code>, so we could add things there.</p>

<p>The second reason was idempotency.  UFW remembers state, so a port
stays open until you explicitly tell it to close.  With Ansible, we
typically just declare a list of open ports, so if you remove a port
from the list, you may think it is closed, but it will remain open on
the machine.  We could reset UFW every playbook run, but that falsely
makes it appear that the everything has changed.  Our current iptables
task guarantees a known state and only displays something as changed
when it actually changes.</p>

<p>It seems like some people are moving to nftables (nft) instead of
iptables.  Something to keep an eye on for the future.</p>

<p>Fail2ban helps a bit on password protected service like IMAP by
limiting the number of attempts an attacker can make before switching
IPs, but is more noise control for the logs than security.  The
version in Debian 10 is fairly recent so we use it stock.  The Debian
9 version was old, so we previously added some custom patterns for
ssh.</p>

<figure>
<img src="images/network.jpg" alt="10BASE-2 FTW">
<figcaption>One alternative to a firewall is to make your network so
unpleasant that attackers move on.  Mix in some thicknet or modems
with accoustic couplers if you can find them.
</figcaption>
</figure>

<div class=copyright>
<p>Copyright &copy; 2020 David Loffredo, licensed under
<a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">
CC BY-SA 4.0</a>.
</p>
</div>
</div>
</body>
</html>
