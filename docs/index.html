<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>DaveCloud Mail and Backup</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
<div class=toc>
<UL>
<LI><A href="index.html">[home]</A>
<LI><A href="https://github.com/david-loffredo/davecloud">[github repo]</A>
<p>
<li><a href="#pkgs">Packages</a>
<li><a href="#start">Getting Started</a>
<li><a href="#hosts">Hosts</a>
<li><a href="#vars">Variables</a>
<li><a href="#first">First Login Playbook</a>
<li><a href="#play">Site Setup Playbook</a>
<li><a href="#reboot">Rebooting</a>
</UL>
</div>

<div class=main>
<H1>DaveCloud Mail, Web, and Backup</H1>

<p>These Ansible scripts set up mail and web service, with regular
backups to a second machine.  Typically, the server is on
a <a href="machines.html">machine in the cloud</a> while backups are
on an old machine in your house.  My three goals were:</p>
<ol>
<li>Mail and web for one or more domains, 
<li>Built securely with modern packages, and proper backups,
<li>A ground-up understanding of what is on the machine and why.
</ol>

<p>These pages explain <em>what</em> I learned, <em>how</em> to
configure it, and <em>why</em> I made the choices that I did for each
aspect of the setup, plus some fun pictures of my old hardware.  If
ground-up knowledge is not your priority, a push-button mail server
like <a href="https://github.com/modoboa/modoboa">Modoboa</a>,
<a href="https://mailinabox.email/">mail-in-a-box</a>, or
<a href="https://github.com/progmaticltd/homebox">homebox</a> is a
fine alternative.</p>

<p>I hope this is a useful starting point for <em>your</em> goals
and choices.</p>


<p>TO DO LIST
<UL>
<LI>Thunderbird has trouble autoconfiging on virtual domains.   Must set port and passwd type manually.   Also the autoconfiging attempts will trip a fail2ban rule, preventing further attempts.
<LI>Look at apticron or unattended-upgrades for keeping patched.
<LI>Null client switch to cert based auth
<LI>Null client extend SQL to allow reject mail to relay@ - sendonly support to the SQL and recipient-access
<LI>Ipset with a variety of Class As to block port 22 and quiet down
the logs.
<LI>Sanitize extra headers on outgoing mail?
<LI>Use LUKS on a whole /data partition rather than EncFS on dirs.
</UL>

<!-- ============================== -->
<H2 class=rule>
<A NAME=pkgs></A>Packages</H2>

<p>This setup assumes Debian 10. <a href="debian.html">Why Debian</a>?
Other distros may be close, but have some differing file locations or
package versions.  In most places, the Ansible playbooks use
the <code>package:</code> module rather than <code>apt:</code> for
installing, so it can work with other package managers like emerge or
yum.  <a href="ansible.html">Why Ansible</a>?</p>

<p>I avoid extra packages, which means fewer things to understand, a
smaller attack surface, and lower machine requirements.  For example,
the virtual mail accounts are managed with SQLite rather than a full
MySQL install, which works just fine for a dozen accounts, has zero
moving parts, and simplifies database security to just file
permissions.</p>


<p>The playbooks cover the following areas: 

<ul>
<li><a href="ssh.html">SSH</a>
<li><a href="firewall.html">Firewall</a>
<li><a href="mail.html">Mail Server</a>
<li><a href="mailnull.html">Mail from Client Machines</a>
<li><a href="apache.html">Web Server</a>
<li><a href="backup.html">Backup</a>
<li><a href="encrypt.html">Encryption</a>
<li><a href="dns.html">DNS</a>
</ul>


<!-- ============================== -->
<H2 class=rule>
<A NAME=start></A>Getting Started</H2>

<p>Check out the <code>davecloud</code> repo.  Make a separate
directory for your settings by recursively copying
<code>hosts.example</code> to someplace <u>outside</u> of the repo.
We call it <code>myhosts</code> here, but any name is fine.

<PRE class=code>
$ https://github.com/david-loffredo/davecloud.git

$ cp -r davecloud/hosts.example myhosts

$ ls
davecloud  myhosts
</PRE>

<p>The new <code>myhosts</code> directory contains
a <code>hosts</code> file and a <code>group_vars</code> directory.
After customizing these as described in the following sections, I
recommend putting this directory under source control.  You can do
that however you like because it is not connected to
the <code>davecloud</code> repo.

<p>If you keep <code>myhosts</code> on Github, I recommend a private
repo.  Passwords will be encrypted in the <code>vault.yml</code> file,
but you probably don't want other inventory detail like IPs, email
addresses and domain names broadly viewable.

<PRE class=code>
$ls -R myhosts/
myhosts/:
group_vars  hosts

myhosts/group_vars:
all

myhosts/group_vars/all:
all.yml  vault.yml
</PRE>

<p>Since all of your settings are kept in a separate, external
directory, you only need to fork <code>davecloud</code> if you plan to
edit the playbooks to do new things.</p>


<!-- ============================== -->
<H2 class=rule>
<A NAME=hosts></A>Hosts</H2>


<p>The <code>myhosts/hosts</code> file
identifies <a href="machines.html">the machines that you are
managing</a>, and organizes them into groups.  The playbooks describe
tasks and roles that apply to the machines in each group.  We use two
groups: <code>cloud</code> and <code>backup-server</code>.</p>

<p>The machines are listed by fully qualified domain name (FQDN) and
IP address, so the machine does not need to show up in DNS yet.
Ansible uses the <code>ansible_host</code> variable to connect, and
sets the <code>inventory_hostname</code> variable to the FQDN for use
in the scripts.</p>

<PRE class=code>
[cloud]
# mail and webserver, needs a public IP address from a business class
# ISP connection or VPS provider like AWS, Linode, or DigitalOcean
example.com		ansible_host=1.2.3.4

[backup-server]
# connects to other machines to fetch and store backups, best if you
# have physical control of the machine.  It does not need a public IP
# and can be behind a residential ISP connection.
guardian.example.com	ansible_host=5.6.7.8
</PRE>

<p>After you have provisioned the machines, <a href="dns.html">create
DNS entries for them</a> using your registrar or other service.  We
may eventually run Bind and make the cloud machine the DNS master, but
still getting that sorted out.</p>


<!-- ============================== -->
<H2 class=rule>
<A NAME=vars></A>Variables</H2>

<p>The <code>myhosts/group_vars</code> directory contains settings
that apply to the groups of machines in the hosts file.  Ansible looks
for a <code>&lt;group-name&gt;.yml</code> file or
a <code>&lt;group-name&gt;/</code> directory containing any number of
YML files.  Every machine belongs to the special <code>all</code>
group, and we use this group for most of our settings.</p>

<p>Within <code>group_vars/all</code>, we put most of our settings in the
<code>all.yml</code> file.  We put sensitive values like passwords in
<code>vault.yml</code>, which is an encrypted
<a href="https://docs.ansible.com/ansible/latest/user_guide/vault.html">Ansible
vault file</a>.</p>

<p>The <code>vault.yml</code> that you copied is not yet encrypted and
contains placeholders for a bunch of things.  Edit it to contain real
values and then encrypt it with your own unique password:

<PRE class=code>
$ ansible-vault encrypt vault.yml	# encrypt plain file
</PRE>

<p>The file stays encrypted.  Use the <code>edit</code> command to
open a clear-text version temporarily in <code>$EDITOR</code> to look
at or modify the contents.  You can also change the password
with <code>rekey</code>.</p>

<PRE class=code>
$ ansible-vault edit vault.yml 		# run EDITOR on file
$ ansible-vault rekey vault.yml		# change password on file
</PRE>

<p>To make it easier to find variables, we prefix each value in 
<code>vault.yml</code> with "vault_" and then declare a version
without the prefix in the <code>all.yml</code> file.  For example, a
password might show up as follows:</p>

<PRE class=code>
something_pw: "{{vault_something_pw}}"   # vault_* is in vault.yml
</PRE>

<p>Data is encrypted as AES256 and stored as a block of ASCII text,
similar to ssh keys.  Ansible will decrypt on-the-fly when running
playbooks.  There are many ways to get the password to Ansible, but we
use the <code>--ask-vault-pass</code> flag to type it in every
time.</p>

<p>You shouldn't need anything beyond the <code>all.yml</code>
and <code>vault.yml</code> for this application, but if you extend
these playbooks for other things, be aware
that <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html">Ansible
variables</a> have an absurd amount of flexibility.



<!-- ============================== -->
<H2 class=rule>
<A NAME=first></A>First Login Playbook</H2>

<p>The first thing to do after provisioning a machine is run the
<code>first.yml</code> playbook to set up a deployment account,
install keys, and then <a href="ssh.html">lock down SSH</a>.

<p>Tasks are executed remotely as <code>root</code>. The
lowercase <code>-k</code> flag is a shorthand
for <code>--ask-pass</code>.  This is the only time a password-based
login ever happens.  Ansible needs the <code>sshpass</code> package on
your local machine to do password-based login to a remote machine.  If
you can pre-install an ssh key for root, you could change this
logic.</p>

<PRE class=code>
$ ansible-playbook -k --ask-vault-pass -i ../myhosts first.yml --limit machinename
</PRE>

<p>After this, remote password login is disabled and everything
requires ssh keys.  All further work uses the deployment account.  It
is a good idea to change or star the root password because the
original passed through your VPS provider's UI.</p>

<!-- ============================== -->
<H2 class=rule>
<A NAME=play></A>Site Setup Playbook</H2>

<p>The <code>site.yml</code> file is the main playbook for our cloud
and backup server machines.  Tasks are executed remotely as
the <code>deploy</code> user, so Ansible needs passwords for the
deploy user (for sudo) and the vault (for decrypting).  The
uppercase <code>-K</code> flag is a shorthand
for <code>--ask-become-pass</code></p>

<p>Ansible playbooks are meant to be idempotent, which means that they
are supposed to leave a machine in a given state, no matter how many
times you run it or what state it was in before.</p>

<PRE class=code>
$ ansible-playbook -K --ask-vault-pass -i ../myhosts site.yml
</PRE>

<p>By default, Ansible runs the playbook on all machines in the
inventory file.  We can limit it to a certain group or machine with
the <code>--limit</code> flag.  We can also select just parts of the
playbook with the <code>--tags</code> flag.</p>

<PRE class=code>
# run the playbook only on the cloud group
$ ansible-playbook -K --ask-vault-pass -i ../myhosts site.yml --limit cloud

# run apache tagged tasks only on the cloud group
$ ansible-playbook -K --ask-vault-pass -i ../myhosts site.yml \
    --limit cloud  --tags apache
</PRE>

<p>Most roles have their own tags, so you can call them selectively.
There is another <a href="snapshot.html">snapshot</a> tag that copies
back certain system data like keys and certs for easy transfer when
wiping or migrating a machine.</p>


<!-- ============================== -->
<H2 class=rule>
<A NAME=reboot></A>Rebooting</H2>

<p>The machine should boot clean and everything will come up except
mail.  Because the mail spool is encrypted, you must log in,
run <code>/etc/postfix/mailboot</code> to enter the EncFS password.
This will mount the cleartext directories and start postfix.</p>

<figure>
<img src="images/sparc20.jpg" alt="Sparc 20">
<figcaption>With robust net connection, a Sparc 20 is a fine
alternative to a VPS in the cloud.  I wouldn't run SunOS 4.1.3 though,
as that is a little old.
</figcaption>
</figure>

<div class=copyright>
<p>Copyright &copy; 2020 David Loffredo, licensed under
<a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
CC BY 4.0</a>.
</p>
</div>
</div>
</body>
</html>
