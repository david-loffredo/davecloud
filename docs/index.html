<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>DaveCloud Mail and Backup</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
<div class=toc>
<UL>
<LI><A href="https://github.com/david-loffredo/davecloud">Github Repo</A>
<p>
<li><a href="#pkgs">Packages</a>
<li><a href="#start">Getting Started</a>
<li><a href="#hosts">Hosts</a>
<li><a href="#vars">Variables</a>
<li><a href="#first">First Login Playbook</a>
<li><a href="#play">Site Setup Playbook</a>
<li><a href="#reboot">Rebooting</a>
</UL>
</div>

<div class=main>
<H1>DaveCloud Mail, Web, and Backup</H1>

<p>These Ansible scripts set up mail and web service, with regular
backups to a second machine.  Typically, the server is on
a <a href="machines.html">machine in the cloud</a> while backups are
on an old machine in your house.  My three goals were:</p>
<ol>
<li>Basic mail and web for one or more domains, 
<li>Built securely with modern packages, and proper backups,
<li>A ground-up understanding of what is on the machine and why.
</ol>

<p>These pages explain <em>what</em> I learned, <em>how</em> to
configure it, and <em>why</em> I made each choice, plus some fun
pictures of my old hardware.

If those details don't interest you, a push-button mail server
like <a href="https://github.com/modoboa/modoboa">Modoboa</a>,
<a href="https://mailinabox.email/">mail-in-a-box</a>, or
<a href="https://github.com/progmaticltd/homebox">homebox</a> is a
fine alternative.</p>

<p>I hope this is a useful starting point for <em>your</em> goals
and choices.</p>

<!-- ============================== -->
<H2 class=rule>
<A NAME=pkgs></A>Packages</H2>

<p>This setup assumes Debian 10. <a href="debian.html">Why Debian</a>?
Other distros could work, but may differ in some package details or
file locations.  In most places, the Ansible playbooks use
the <code>package:</code> module rather than <code>apt:</code> for
installing, so it can work with emerge or
yum.  <a href="ansible.html">Why Ansible</a>?</p>

<p>I avoid extra packages, which means fewer things to understand, a
smaller attack surface, and lower machine requirements.  For example,
instead of MySQL, virtual mail accounts are managed with SQLite, which
is fast, has zero moving parts, and is easily secured with file
permissions.  We also run unattended upgrades to install security
patches once a day.</p>

<p>The playbooks cover the following areas: 

<ul>
<li><a href="ssh.html">SSH</a>
<li><a href="firewall.html">Firewall</a>
<li><a href="mail.html">Mail Server</a>
<li><a href="mailnull.html">Mail Relay</a>
<li><a href="apache.html">Web Server</a>
<li><a href="backup.html">Backup</a>
<li><a href="encrypt.html">Encryption</a>
<li><a href="dns.html">DNS</a>
</ul>


<!-- ============================== -->
<H2 class=rule>
<A NAME=start></A>Getting Started</H2>

<p>Check out the <code>davecloud</code> repo.  Make a separate
directory for your settings by recursively copying
<code>hosts.example</code> to someplace <u>outside</u> of the repo.
We call it <code>myhosts</code> here, but any name is fine.

<PRE class=code>
$ https://github.com/david-loffredo/davecloud.git

$ cp -r davecloud/hosts.example myhosts

$ ls
davecloud  myhosts
</PRE>

<p>The new <code>myhosts</code> directory contains
a <code>hosts</code> file and a <code>group_vars</code> directory.
After customizing these as described below, I recommend putting this
directory under source control.  You can do that however you like
because it is not connected to the <code>davecloud</code> repo.

<p>Use a private repo if you keep <code>myhosts</code> on Github.
Passwords will be encrypted in <code>vault.yml</code>, but you
probably don't want IPs, emails, and domain names world viewable.
Your settings are in a separate directory, so you only need to
fork <code>davecloud</code> if you edit playbooks to do new
things.</p>


<!-- ============================== -->
<H2 class=rule>
<A NAME=hosts></A>Hosts</H2>


<p>The <code>myhosts/hosts</code> file
identifies <a href="machines.html">the machines that you are
managing</a>, and organizes them into groups.  The playbooks describe
tasks and roles that apply to the machines in each group.  We use two
groups: <code>cloud</code> and <code>backup-server</code>.</p>

<p>The machines are listed by fully qualified domain name (FQDN) and
IP address, so the machine does not need to show up in DNS yet.
Ansible uses the <code>ansible_host</code> variable to connect, and
sets the <code>inventory_hostname</code> variable to the FQDN for use
in the scripts.</p>

<PRE class=code>
[cloud]
# mail and webserver, needs a public IP address from a business class
# ISP connection or VPS provider like AWS, Linode, or DigitalOcean
example.com		ansible_host=1.2.3.4

[backup-server]
# connects to other machines to fetch and store backups, best if you
# have physical control of the machine.  It does not need a public IP
# and can be behind a residential ISP connection.
guardian.example.com	ansible_host=5.6.7.8
</PRE>

<p>After you have provisioned the machines, <a href="dns.html">create
DNS entries for them</a> using your registrar or other service.  We
may eventually run Bind and make the cloud machine the DNS master, but
still getting that sorted out.</p>


<!-- ============================== -->
<H2 class=rule>
<A NAME=vars></A>Variables</H2>

<p>The <code>myhosts/group_vars</code> directory contains settings for
the groups of machines in the hosts file.  Ansible looks for
a <code>&lt;group-name&gt;.yml</code> file or
a <code>&lt;group-name&gt;/</code> directory containing YML files.
Every machine belongs to the special <code>all</code> group.</p>

<p>Most of our settings are in <code>group_vars/all/all.yml</code>.
Look through this file and customize the values as appropriate.  Some
things that are unique to the mail and web server, and that we do not
want to apply to the backup server, are
in <code>group_vars/cloud.yml</code>.

<p>Sensitive values like passwords are in
<code>group_vars/all/vault.yml</code>, which will be an encrypted
<a href="https://docs.ansible.com/ansible/latest/user_guide/vault.html">Ansible
vault file</a>.  The <code>vault.yml</code> that you copied is not yet
encrypted and contains placeholders.  Edit it to contain real values
and then encrypt it with your own unique password:

<PRE class=code>
$ ansible-vault encrypt vault.yml	# encrypt plain file
</PRE>

<p>The file stays encrypted.  Use the <code>edit</code> command to
open a clear-text version temporarily in <code>$EDITOR</code> to look
at or modify the contents.  You can also change the password
with <code>rekey</code>.</p>

<PRE class=code>
$ ansible-vault edit vault.yml 		# run EDITOR on file
$ ansible-vault rekey vault.yml		# change password on file
</PRE>

<p>To make it easier to find variables, we prefix each value in 
<code>vault.yml</code> with "vault_" and then declare a version
without the prefix in the other files.  For example, a password might
show up as follows:</p>

<PRE class=code>
something_pw: "{{vault_something_pw}}"   # vault_* is in vault.yml
</PRE>

<p>Ansible vault files are encrypted as AES256 and stored as a block
of ASCII text, similar to ssh keys.  Ansible will decrypt on-the-fly
when running playbooks.  There are many ways to get the password to
Ansible, but we use the <code>--ask-vault-pass</code> flag to type it
in every time.</p>

<p>You shouldn't need anything beyond these files for this
application, but if you extend these playbooks for other things, be
aware
that <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html">Ansible
variables</a> have an absurd amount of flexibility.  Each role also
has settings in <code>&lt;ROLE&gt;/defaults/main.yml</code> that you can override.



<!-- ============================== -->
<H2 class=rule>
<A NAME=first></A>First Login Playbook</H2>

<p>The first thing to do after provisioning a machine is run the
<code>first.yml</code> playbook to set up a deployment account,
install keys, and then <a href="ssh.html">lock down SSH</a>.

<p>Tasks are executed remotely as <code>root</code>. The
lowercase <code>-k</code> flag is a shorthand
for <code>--ask-pass</code>.  This is the only time a password-based
login ever happens.  Ansible needs the <code>sshpass</code> package on
your local machine to do password-based login to a remote machine.  If
you can pre-install an ssh key for root, you could change this
logic.</p>

<PRE class=code>
$ ansible-playbook -k --ask-vault-pass -i ../myhosts first.yml --limit machinename
</PRE>

<p>After this, remote password login is disabled and everything
requires ssh keys.  All further work uses the deployment account.  It
is a good idea to change or star the root password because the
original passed through your VPS provider's UI.</p>

<!-- ============================== -->
<H2 class=rule>
<A NAME=play></A>Site Setup Playbook</H2>

<p>The <code>site.yml</code> file is the main playbook for our cloud
and backup server machines.  Tasks are executed remotely as
the <code>deploy</code> user, so Ansible needs passwords for the
deploy user (for sudo) and the vault (for decrypting).  The
uppercase <code>-K</code> flag is a shorthand
for <code>--ask-become-pass</code></p>

<p>Ansible playbooks are meant to be idempotent, which means that they
are supposed to leave a machine in a given state, no matter how many
times you run it or what state it was in before.</p>

<PRE class=code>
$ ansible-playbook -K --ask-vault-pass -i ../myhosts site.yml
</PRE>

<p>By default, Ansible runs the playbook on all machines in the
inventory file.  We can limit it to a certain group or machine with
the <code>--limit</code> flag.  We can also select just parts of the
playbook with the <code>--tags</code> flag.</p>

<PRE class=code>
# run the playbook only on the cloud group
$ ansible-playbook -K --ask-vault-pass -i ../myhosts site.yml --limit cloud

# run apache tagged tasks only on the cloud group
$ ansible-playbook -K --ask-vault-pass -i ../myhosts site.yml \
    --limit cloud  --tags apache
</PRE>

<p>Most roles have their own tags, so you can call them selectively.
There is another <a href="snapshot.html">snapshot</a> tag that copies
back certain system data like keys and certs for easy transfer when
wiping or migrating a machine.</p>


<!-- ============================== -->
<H2 class=rule>
<A NAME=reboot></A>Rebooting</H2>

<p>The machine should boot clean and everything will come up except
mail.  Log in and run <code>mailboot</code> as root.  Enter the
encrypted directory password and the script will mount the cleartext
data and start the mail daemon.</p>

<figure>
<img src="images/sparc20.jpg" alt="Sparc 20">
<figcaption>With robust net connection, a Sparc 20 is a fine
alternative to a VPS in the cloud.  I wouldn't run SunOS 4.1.3 though,
as that is a little old.
</figcaption>
</figure>

<div class=copyright>
<p>Copyright &copy; 2020 David Loffredo, licensed under
<a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
CC BY 4.0</a>.
</p>
</div>
</div>
</body>
</html>
