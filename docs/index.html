<!DOCTYPE html>
<HTML>
<HEAD>
   <TITLE>Server Configuration</TITLE>
   <link rel="stylesheet" type="text/css" href="style.css">
</HEAD>
<BODY>
<div class=toc>
<UL>
<LI><A href=index.html>[home]</A>
<p>
<LI><A href=pkgs>Packages</A>
<LI><A href=vars>Variables</A>
<LI><A href=first>First Login Playbook</A>
<LI><A href=play>Site Setup Playbook</A>
<LI><A href=reboot>Rebooting</A>
</UL>
</div>

<H1>Server Configuration</H1>

<p>These are Ansible roles that I have built for my own use to run web
service and email, and to do regular backups.  They assume Debian 10.
I use the simplest solutions that I can find, both for minimal machine
requirements and minimal attack surface.  For example, SQLite rather
than a full MySQL install for a half dozen virtual mailboxes.

<p>I began this project by studying sovereign, homebox, mail in a box,
frjo's ansible setups and other resources.  It is easy to fall into
the cargo cult sysadmin trap by just following recipes, so I tried to
use them as inspiration, examine all of the design decisions, and then
make my own conscious decisions, which I have documented here and in
the YML files.</p>

<p>TO DO LIST
<UL>
<LI>Client configured for bacula, configure director.  Try using a
local NATed machine (Pi Zero) as the director
<LI>Configure exim to send authenticated system mail from clients so
that they can be behind a NATed firewall.
<LI>Set the hostname
<LI>Configure RSPAMD with postfix.
<LI>Deploy DNS on live machine
<LI>Configure DKIM and automate key rotation with postfix and DNS.
<LI>Configure DMARC entry in the DNS.
<LI>Cut over on actual sites.
<LI>Thunderbird has trouble autoconfiging on virtual domains.   Must set port and passwd type manually.   Also the autoconfiging attempts will trip a fail2ban rule, locking you out.
<LI>Look at apticron or unattended-upgrades for keeping patched.
</UL>

<p>Can run dpkg-reconfigure on packages

<!-- ============================== -->
<H2 class=rule>
<A NAME=pkgs></A>Packages</H2>

<ul>
<li><a href="firewall.html">Firewall</a>
<li><a href="apache.html">Web Server</a>
<li><a href="certbot.html">Certbot/LetsEncrypt</a>
<li><a href="mail.html">Mail</a>
<li><a href="dns.html">DNS Configuration</a>
<li><a href="backup.html">Backup</a>
<p>
</ul>

<p>Debian uses <code>apt</code> as the package manager.  The
<a href=https://www.debian.org/distrib/packages>Debian packages</a>
and the <a href=https://backports.debian.org/Packages/>Backport
packages</a> are available for install.  To list the
installed and available versions

<PRE class=code>
apt list &lt;pkg&gt;
apt list &lt;pkg&gt; -a    # list all versions in the repo
</PRE>

<p>If you need to completely uninstall and reinstall a package.

<PRE class=code>
apt-get --purge remove &lt;pkg&gt;
apt-get install &lt;pkg&gt;
</PRE>

<!-- ============================== -->
<H2 class=rule>
<A NAME=vars></A>Variables</H2>

<p>The ansible variables are located under the <b>group_vars</b>
directory.  Right now we are just using a single <b>all</b> set, but
you can get fancier if you have multiple machines and want to track
more variations.</p>

<p>Private information like passwords and such are stored encrypted in a
<a href="https://docs.ansible.com/ansible/latest/user_guide/vault.html">vault
file</a>.  Ansible asks for the password to this when
the <code>--ask-vault-pass</code> flag is given.  You can edit and
manipulate it from the command line with:
<PRE class=code>
ansible-vault edit foo.yml 		# run EDITOR on file

ansible-vault rekey foo.yml 		# change password on file
ansible-vault encrypt foo.yml 		# encrypt plain file
ansible-vault decrypt foo.yml 		# convert encrypted to plain file
</PRE>

<p>To make it easier to keep track of everything, the cleartext vars
file has a stub for each value hidden in the vault.  The stub simply
references a similar variable with a "vault_" prefix that is stored in
the encrypted vault file.  For example, a password might show up like
the following in the cleartext file.

<PRE class=code>
  - email: "somebody@foobar.com"
    pw: "{{vault_mbox_someone_pw}}"
</PRE>


<!-- ============================== -->
<H2 class=rule>
<A NAME=first></A>First Login Playbook</H2>

<p>The first thing to do after provisioning a machine is run the
first.yml playbook to lock down SSH.  This should be the only time a
password based login is used with the machine.  You need "sshpass"
installed locally because the remote machine does not yet have any
keys installed.  After this, remote password login is disabled and
everything uses ssh keys.  It is also a good idea to change the root
password manually because the original passed through the Linode UI.
The lowercase <code>-k</code> flag is a shorthand
for <code>--ask-pass</code>

<PRE class=code>
$ ansible-playbook -k --ask-vault-pass -i hosts first.yml --extra-vars "target=guardian"
</PRE>
<p><b>UPDATE</b> now we are preinstalling a public key for  needs to be in openssh form; to convert keys from
putty, install the putty-utils package and do:


<p>The public key needs to be in openssh form; to convert keys from
putty, install the putty-utils package and do:

<PRE class=code>
$ puttygen foobar.ppk -O public-openssh -o foobar.pub
$ puttygen foobar.ppk -O private-openssh -o foobar.key
</PRE>

<p>When you rebuild a machine, the host key changes and SSH freaks out
with ominous messages about man in the middle attacks.  You can
selectively make ssh forget the key for the name and IP using commands
like below.

<PRE class=code>
$ ssh-keygen -f "/home/foo/.ssh/known_hosts" -R "example.com"
$ ssh-keygen -f "/home/foo/.ssh/known_hosts" -R "11.22.33.44"
</PRE>



<!-- ============================== -->
<H2 class=rule>
<A NAME=play></A>Site Setup Playbook</H2>

<p>The <code>site.yml</code> playbook configures machines for the
services described below.  Ansible playbooks are is meant to be
idempotent, which means that they are supposed to leave a machine in a
given state, no matter how many times you run it or what state it was
in before.</p>

<p>The command below runs the playbook on all machines in the 'hosts'
inventory file.  It runs as the <b>deploy</b> user and asks passwords
for sudo on the deploy user and the vault password.  Both are the
stpbuild passwords.  The uppercase <code>-K</code> flag is a shorthand
for <code>--ask-become-pass</code>

<PRE class=code>
$ ansible-playbook -K --ask-vault-pass -i hosts site.yml
</PRE>

<p>There is another <a href="snapshot.html">snapshot.yml</a> playbook
that copies back certain data like the letsencrypt keys so that they
can be transfered over when wiping or migrating a machine.  This
playbook is run in the same way as <code>site.yml</code>.


<!-- ============================== -->
<H2 class=rule>
<A NAME=reboot></A>Rebooting</H2>

<p>The machine should boot clean and everything will come up except
mail.  Because the mail spool is encrypted, you must log in,
run <b>/etc/postfix/mailboot</b> to enter the EncFS password.  This
will mount the cleartext directories and start postfix.


</BODY>
</HTML>
