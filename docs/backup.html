<!DOCTYPE html>
<HTML>
<HEAD>
   <TITLE>Backup</TITLE>
   <link rel="stylesheet" type="text/css" href="style.css">
</HEAD>
<BODY>
<div class=toc>
<UL>
<LI><A href=index.html>[home]</A>
</UL>
</div>

<H1>Backup</H1>

<p><b>ROLE</b> bacula-client, bacula-director

TODO:

Defaults to postgres -- try to get sqlite running.
Could not open /usr/libexec/bacula/query.sql: ERR=No such file or directory

/usr/share/bacula-common/dbtype
/usr/share/bacula-director/ all DB scripts

bacula-director-mysql
bacula-director-pgsql
bacula-director-sqlite



Make the files configurable

<p>We use <a href="https://www.bacula.org/">Bacula</a> to manage
backups.  On the machine to be backed up, this is enabled by the
"bacula-client" role.  Backups are initiated by and stored on a
separate machine which is configured by the "bacula-director"
role.</p>

<p>Since the client is in the cloud and our director will likely be
NATed and behind a firewall, we leave the Bacula ports blocked on the
client.  When it is time for a backup, connection is initiated by the
director, which set up an ssh tunnel to the right ports.  We use a
restricted backup account with a separate ssh key just to set up the
tunnel, as described in
the <a href="https://wiki.bacula.org/doku.php?id=sshtunnel">Bacula
wiki</a>.  We can back up a mix of many machines, some needing a
tunnel (like a cloud machine) and some that can directly connect (like
a local PC).</p>

<p>We will back up the list of config files covered by
the <a href="snapshot.html">snapshot</a> playbook, plus the mail
spool.  May or may not back up the document roots for the web sites.
Is it worth it to back up logs?

<p>Bacula has several processes that run, usually spread over at least
two machines, and they are configured by the following:
<ul>
<li><code>bacula-fd.conf</code> - File daemon on each client machine.
Authorizes one or more directors to contact it.

<li><code>bacula-dir.conf</code> - The director on the backup server
machine.  Defines all of the client machines to contact, what to get
from each, and where to put it, and the scheduling.  Also configures
an SQL database to use for cataloging all of the files across all of
the clients.   Usually there is only one director.

<li><code>bacula-ds.conf</code> - Storage daemon, usually on the
backup server machine but could be elsewhere.  Defines storage devices
like disk or tape and authorizes one or more directors to contact it.

<li><code>bconsole.conf</code> - Console, for talking with a director
for status or to restore files.  Defines the director to talk to.
</ul>

<h2>Why I chose Bacula</h2>

<p>Initially I planed to
use <a href="https://www.borgbackup.org/">Borg</a> because it is
simple to configure, has a nice list of features like deduplication,
encryption, and a good community.  It stores data on local disk or
over SSH to a server like
by <a href="https://www.rsync.net/products/borg.html">rsync.net</a>.
Borg won't go to an S3 bucket, but a similar project called
<a href="https://restic.net/">Restic</a> will.

<p>Once I started considered <em>who</em> could access the backups, I
changed my mind.  Borg and Restic work from the client, which guards
against a disk crash or mistake, but offers no protection for a p0wned
machine.  If a client can access past backups for pruning, etc, an
attacker can mess with them too.  Borg has an append-only mode for
this, but it just queues deletions until a trusted machine touches the
backups.  This makes any pruning of old backups dangerous unless you
are sure nothing was compromised.

<p>So after considering all of these factors, I returned to Bacula,
which is slightly more complex to configure, but covers oopsie and
p0wnage, scales to as many machines as you want, and has all storage
options, including tape (which Borg thinks no longer exists).  It
requires setting up more than one machine, but a $10 Rapsberry Pi Zero
sitting on a shelf is more than adaquate for backing up a personal
email/web server.

<h2>Client-initiated backups with Bacula</h2>

<P>If a client is only intermittently available, but can contact the
director when present, create an empty Schedule and have the client
connect the director using bconsole.  Not sure how well this actually
works, but see
https://resources.infosecinstitute.com/data-backups-bacula-mobile-devices/


</BODY>
</HTML>


