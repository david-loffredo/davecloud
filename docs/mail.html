<!DOCTYPE html>
<HTML>
<HEAD>
   <TITLE>Mail</TITLE>
   <link rel="stylesheet" type="text/css" href="style.css">
</HEAD>
<BODY>
<div class=toc>
<UL>
<LI><A href=index.html>[home]</A>
<p>
<li><a href="#vars">Variables</a>
<li><a href="#mailcfg">Mailcfg</a>
<li><a href="#rspamd">Spam Filtering</a>
<li><a href="#mailq">Managing the Mail Queue</a>
<li><a href="#nullclient">Mailnull Role for Client Machines</a>
<li><a href="#nullclient_vars">Mailnull Variables</a>
<li><a href="#why">Why These Packages?</a>
</UL>
</div>

<H1>Mail Server</H1>

<p><b>ROLE</b> mailhost, mailnull

<p>The <code>mailhost</code> role configures a machine as a mail
server.  It receives mail from the outside world and delivers to
mailboxes accessible via IMAP.  We use Postfix for the mail transfer
agent (MTA) and Dovecot as the local delivery agent (LDA) and IMAP
server.  Rspamd is the only milter used, and enables the default
checks. Volume of mail is not expected to be high enough to benefit
from postscreen.</p>

<p>The <code>mailnull</code> role configures a machine as a <em>null
client</em> - any outgoing mail from system jobs like cron or bacula
is relayed to the central mailhost and no local delivery is done.  We
use Postfix for the null client too.</p>

<p>All accounts are virtual mailboxes.  The machine only has system
unix accounts and no mail is delivered to them.  The virtual user
database holds account details in a set of SQL tables.  Background on
virtual users can be found
at <a href="http://www.postfix.org/VIRTUAL_README.html">postfix.org</a>
You can manage users with the <a href="#mailcfg">mailcfg</a> script.
This is a perl script that uses DBI, so you can tweak the connect
statement and SQL as needed for use with other RDBs.</p>

<p>The mail is stored in maildir format and encrypted using EncFS.
The encrypted directory is <code>/var/vmail_crypt</code> and mounted
as cleartext in <code>/var/vmail</code>.  All mail is owned by the
vmail user.

<p>We use SQLite for the database because this is small, simple, and
relatively static, but you can use MySQL, Maria, or Postgres if you
prefer.  On Debian, smtpd runs chrooted
to <code>/var/spool/postfix</code>, so we
store <code>maildb.sqlite3</code> encrypted like the mail in
<code>/var/spool/postfix/etc/maildb_crypt</code>
and <code>maildb</code> so that postfix can authenticate against it.
If you also run dovecot chrooted, you may have to switch to mysql so
that you can access via network port rather than file.

<p>On reboot, postfix does not start automatically because these
encrypted directories must first be mounted.  Log in and run
<code>/etc/postfix/mailboot</code> to enter the password, mount the
cleartext directories, and start postfix.</p>


<!-- ============================== -->
<H2 class=rule>
<A NAME=vars></A>Variables</H2>




<!-- ============================== -->
<H2 class=rule>
<A NAME=mailcfg></A>Mailcfg</H2>

<p>I wrote the <b>/etc/postfix/mailcfg</b> utility to manage these
tables.  Run it as "mailcfg &lt;command&gt;".  The following commands
are available:

<PRE class=code>
 help		Print this message

 addalias &lt;src&gt; &lt;dst&gt;	Adds alias if missing
 adddom &lt;dom&gt;		Add domain if missing
 adduser &lt;email&gt; &lt;pw&gt;	Adds user if missing

 lsalias [&lt;dom&gt;]	List aliases, all or for a domain
 lsdom			List known domain
 lsuser [&lt;dom&gt;]		List users, all or for a domain

 rmalias &lt;src&gt;		Remove alias
 rmalias -id &lt;num&gt;	Remove alias with given id
 rmdom &lt;dom&gt;		Remove domain
 rmuser &lt;email&gt; 	Removes user

 passwd &lt;email&gt; &lt;pw&gt;	Changes user password 
 disable &lt;email&gt;	Marks user as inactive
 enable &lt;email&gt;		Marks user as active
</PRE>


<!-- ============================== -->
<H2 class=rule>
<A NAME=rspamd></A>Spam Filtering</H2>

<p>The rspamd web console is run
at <code>http://localhost:11334</code>, but that port is normally
blocked and the server only allows connections from localhost.  You
should can set up an SSH tunnel in order to use it.  Either do it from
the command line or you can add the following to the config file entry
for that machine.

<PRE class=code>
LocalForward 11334 localhost:11334
</PRE>

<p>We set up dovecot with the sieve module for automatic sorting of
mail and create some global rules under <code>/var/vmail/sieve</code>
to deliver all spam to the junk folder.  We also add some rules to
train the filter when mail is dragged into or out of the junk folder.


<PRE>
  Remote MTA -> Rspamd (milter) -> Postfix -> Rspamd (rspamc) -> Dovecot -> user mailbox
</PRE>

<p>Mail from the remote MTA is received by Postfix and run through
Rspamd.  Greylisting and rejects happen in this pipeline.  Once
Postfix receives the message, it is sent to Dovecot over LMTP.
Dovecot uses the antispam module to run rspamc (employing Rspamd).
The sieve module is finally used to process headers added by Rspamd or
any other milters.


<p>If we open up port 4190 or tunnel, clients can use the managesieve
daemon.  There doesn't seem to be a lot of client support for it
though.


- Use `rspamadm` to look at the configuration.
- Use `rspamc` or the web-based console to scan problematic messages
  and see how rspamd scores them.

### DMARC

For verifying DMARC operation, read the rpsamd log in
`/var/log/rspamd` to verify the report generator is running.

For receiving reports, you will get an email if a message comes from
your server that fails authentication (although by configuring
`p=none`, any such email should not be rejected by the other
server).



<!-- ============================== -->
<H2 class=rule>
<A NAME=mailq></A>Managing the Mail Queue</H2>

<p>To inspect and manipulate mail queue, the following commands, run
as root on the server, are helpful.

<PRE class=code>
List the contents of the mail queue
# mailq

Flush the queue (try to deliver mail)
# postfix flush

Delete everything in the queue
# postsuper -d ALL

Delete only deferred mail, that would otherwise retry later
# postsuper -d ALL deferred

You can also look at a particular message ID in the queue
# postcat -vq XXXXXXXXXX
</PRE>



<!-- ============================== -->
<H2 class=rule>
<A NAME=nullclient></A>Mailnull Role for Client Machines</H2>

<p>The <code>mailnull</code> role configures a machine as a <em>null
client</em> - any outgoing mail from system jobs like cron or bacula
is relayed to the central mailhost and no local delivery is done.  We
use Postfix for the null client too.</p>

<p>The mail server is configured to always accept mail from the local
host, specific whitelisted IP addresses, and from clients that
authorize using a user name and password (user agents like Thunderbird
or phones).  Everything else is subjected to the full battery of
tests.</p>

<p>Historically, you whitelist the local network block so that other
machines at your site can submit mail from system things like cron
jobs.  The other machines on site are configured as null clients to
relay all mail through the central mailserver.  This can also work if
your machines are spread among the cloud, as long as they have fixed
IP addresses known ahead of time.</p>

<p>In the case of machines behind an ISP with changable IPs, or for
machines come or go with an unpredictable IP, we need a different
approach.  Those machines still relay all mail, but when they connect,
they authorize with a special "relay" account, so they can be treated
like a normal user agent.  We would like to configure the mail server
to only accept mail for local addresses when authenticated with this
account, but postfix only restricts based on the FROM, not the AUTH
(you can force the two to match, but that does not help us much)</p>


<!-- ============================== -->
<H2 class=rule>
<A NAME=nullclient_vars></A>Mailnull Variables</H2>

<p>The only variables that needs to be configured for the null client
is the relay account password as <code>vault_mail_relay_pw</code> in
an Ansible vault .  The relay account, host and port can also be set,
but the defaults are usually fine.  The default values are shown
below:

<PRE class=code>
# Relay all mail through a smarthost with authentication using the
# given account and password.

mail_relay_acct:   "relay@{{ domain }}"
mail_relay_pw:     "{{vault_mail_relay_pw}}"

mail_relay_host:   "{{ mail_server_hostname }}"
mail_relay_port:   587
</PRE>


<!-- ============================== -->
<H2 class=rule>
<A NAME=why></A>Why These Packages?</H2>

<p>Back when dinosaurs weren't just in zoos, there was one mailer, its
name was Sendmail, and it was configured by the black speech of
M4-dor, which I will not utter here.  If you were lucky you had a
leased line, but more often than not a couple of times a day you
dialed in and swapped all of your messages via uucp.</p>

<p>OK, Boomer moment over.  I really <b>did not</b> want to set up
system around Sendmail.  I could do it, and it still does a fine job,
but other great options exist that don't predate the fall of
N&uacute;menor.</p>

<p>As of this writing, the top three MTAs by number of servers are
Exim (580k), Postfix (328k), and Sendmail (80k).  Of course, that says
nothing about the volume of mail passing through each server, but it
does give an idea of the general level of support.</p>

<p>The default MTA for Debian is exim4, and it is capable.  I did some
tests setting it up as a null client.  Ultimately, I chose Postfix.
It is easy to find documentation for all of the use cases that
interest me, has ample performance, and reasonable configuration
files. It also supports the milter interface introduced by Sendmail,
which is very nice for rejecting spam early in the connection.</p>

<p>Dovecot is the customary choice for Local Delivery Agent and IMAP
server.  It seems like Cyrus and Courier are other possibilities but I
have no familiarity with them.</p>

<p>I currently use EncFS to <a href="encrypt.html">encrypt the
mailspool</a>.  It works, but I had some problems with "Error:
Couldn't create mailbox list lock file_create_locked() failed".  This
is probably an interaction with EncFS and FUSE, and changing
the <b>lock_method</b> to "dotlock" instead of the default (fcntl)
seemed to fix the issue.  I would like to eventually switch to ext4
encryption and fscrypt, which operates at a block level.</p>

</BODY>
</HTML>

