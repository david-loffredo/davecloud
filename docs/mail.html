<!DOCTYPE html>
<HTML>
<HEAD>
   <TITLE>Mail</TITLE>
   <link rel="stylesheet" type="text/css" href="style.css">
</HEAD>
<BODY>
<div class=toc>
<UL>
<LI><A href=index.html>[home]</A>
</UL>
</div>

<H1>Mail Server</H1>

<p><b>ROLE</b> mailhost

<p>The email configuration is handled by the "mail" role.  Postfix is
used as the MTA and Dovecot for the LDA and IMAP server.  Rspamd will
be the only milter used.

<p>All accounts are virtual mailboxes.  The machine only has system
unix accounts and no mail is delivered to them.  The virtual user
database holds account details in a set of SQL tables.  Background on
virtual users can be found
at <a href="http://www.postfix.org/VIRTUAL_README.html">postfix.org</a>

<p>I wrote the <b>/etc/postfix/mailcfg</b> utility to manage these
tables.  Run it as "mailcfg &lt;command&gt;".  The following commands
are available:

<PRE class=code>
 help		Print this message

 addalias &lt;src&gt; &lt;dst&gt;	Adds alias if missing
 adddom &lt;dom&gt;		Add domain if missing
 adduser &lt;email&gt; &lt;pw&gt;	Adds user if missing

 lsalias [&lt;dom&gt;]	List aliases, all or for a domain
 lsdom			List known domain
 lsuser [&lt;dom&gt;]		List users, all or for a domain

 rmalias &lt;src&gt;		Remove alias
 rmalias -id &lt;num&gt;	Remove alias with given id
 rmdom &lt;dom&gt;		Remove domain
 rmuser &lt;email&gt; 	Removes user

 passwd &lt;email&gt; &lt;pw&gt;	Changes user password 
 disable &lt;email&gt;	Marks user as inactive
 enable &lt;email&gt;		Marks user as active
</PRE>

<p>We use SQLite for the database because this is small, simple, and
relatively static, but you can use MySQL, Maria, or Postgres if you
prefer.  The <b>mailcfg</b> perl utility uses DBI and might just need
a few minor changes to the connect statement and SQL for use with
other RDBs.</p>

<p>The mail is stored in maildir format and encrypted using EncFS.
The encrypted directory is <b>/var/vmail_crypt</b> and mounted as
cleartext in <b>/var/vmail</b>.  All mail is owned by the vmail user.
Started having problems with "Error: Couldn't create mailbox list lock
file_create_locked() failed ... Operation not permitted" This may be
an interaction with EncFS and FUSE, but changing
the <b>lock_method</b> to "dotlock" instead of the default (fcntl)
seemed to fix the issue.  Consider switching to ext4 encryption and
fscrypt, which operates at a block level.

<p>On Debian, smtpd runs chrooted to <b>/var/spool/postfix</b>, so we
store maildb.sqlite3 encrypted like the mail in
<b>/var/spool/postfix/etc/maildb_crypt</b> and <b>maildb</b> so that
postfix can authenticate against it.  If you also run dovecot
chrooted, you may have to switch to mysql so that you can access via
network port rather than file.

<p>On reboot, postfix does not start automatically because these
encrypted directories must first be mounted.  Log in and run
<b>/etc/postfix/mailboot</b> to enter the password, mount the
cleartext directories, and start postfix.


<h2>FUTURE WORK -- MILTERS NOT YET IMPLEMENTED</h2>

<p>Mail delivery looks like this:

<PRE>
  Remote MTA -> Rspamd (milter) -> Postfix -> Rspamd (rspamc) -> Dovecot -> user mailbox
</PRE>

<p>Mail from the remote MTA is received by Postfix and run through
Rspamd.  Greylisting and rejects happen in this pipeline.  Once
Postfix receives the message, it is sent to Dovecot over LMTP.
Dovecot uses the antispam module to run rspamc (employing Rspamd).
The sieve module is finally used to process headers added by Rspamd or
any other milters.

## Mail filters

The only mail filter (milter) used is [Rspamd](https://rspamd.com),
which runs on port 11332.  Rspamd is hooked into postfix with the
`smtpd_milters` variable.  See `etc_postfix_main.cf`.

## Debugging

### Rspamd

A few tips:

- Rspam's console listens on `127.0.0.1:11334`.  As above, you can use
  ssh to port forward (e.g., -L 8080:localhost:11334).  The password is `d1`.
- Use `rspamadm` to look at the configuration.
- Use `rspamc` or the web-based console to scan problematic messages
  and see how rspamd scores them.

### DMARC

For verifying DMARC operation, read the rpsamd log in
`/var/log/rspamd` to verify the report generator is running.

For receiving reports, you will get an email if a message comes from
your server that fails authentication (although by configuring
`p=none`, any such email should not be rejected by the other
server).





<H1>System Mail from Client Machines</H1>
<p><b>ROLE</b> mailnull

<p>The mail server is configured to always accept mail from the local
host, specific whitelisted IP addresses, and from authorized clients
(user agents like Thunderbird or phones).  Everything else is
subjected to the full battery of tests.</p>

<p>Historically, you whitelist the local network block so that other
machines at your site can submit mail from system things like cron
jobs.  The machines on site are configured to relay all mail through
the main mailserver.  This can also work if your machines are spread
among the cloud, as long as they have fixed IP addresses known ahead
of time.</p>

<p>In the case of machines behind an ISP with changable IPs, or for
machines come or go with an unpredictable IP, we need a different
approach.  Those machines still relay all mail, but when they connect,
they authorize with a special "relay" account, so they can be treated
like a normal user agent.  We would like to configure the mail server
to only accept mail for local addresses when authenticated with this
account, but postfix only restricts based on the FROM, not the AUTH
(you can force the two to match, but that does not help us much)

<p>The default MTA for Debian is exim4, and it can be set it up in
this way, but we already use postfix on the server, so I just stick
with that.</p>

</BODY>
</HTML>

