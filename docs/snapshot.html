<!DOCTYPE html>
<HTML>
<HEAD>
   <TITLE>Snapshot</TITLE>
   <link rel="stylesheet" type="text/css" href="style.css">
</HEAD>
<BODY>
<div class=toc>
<UL>
<LI><A href=index.html>[home]</A>
</UL>
</div>

<div class=main>
<H1>Snapshot System Data</H1>

<p><b>TAG</b> snapshot

<p>Both system and user data is backed up by Bacula.  In a disaster
recovery situation, we would do a clean install and replace the system
and user data from backups after the machine is running.  During the
install we would end up generating a bunch of keys and certs, perhaps
from third parties like LetsEncrypt, that we would then abandon.</p>

<p>If we are reimaging or migrating to a new machine in a pre-planned
fashion, we can collect small amounts of unique local system data like
certs, host keys, mail passwords, and DKIM keys for use when doing the
initial install.  This avoids churning the certs and keys.  Once the
machine is up and running, you can use Bacula to restore the larger
volume of user data like the mail spool and web roots.</p>

<p>Use the <code>snapshot</code> tag with <code>site.yml</code> to
create a <code>snapshot/&lt;hostname&gt;</code> local directory for
each machine.  This will contain tarfiles with system data collected
from the machine.  The various roles in the playbook this directory
exists and restores the data if it is present.</p>

<p>After the machine is configured, remove the snapshot directory so
that it does not go stale and inadvertantly overwrite good data weeks
or months later.</p>

<PRE class=code>
# make snapshot/machine.name directory
$ ansible-playbook -K --ask-vault-pass -i ../myhosts site.yml --tags snapshot

# wipe/rebuild machine

# initialize the new machine
$ ansible-playbook -k --ask-vault-pass -i ../myhosts first.yml
$ ansible-playbook -K --ask-vault-pass -i ../myhosts site.yml

# delete snapshot/machine.name directory
</PRE>

</div>
</BODY>
</HTML>

